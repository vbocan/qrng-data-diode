services:
  qrng-gateway:
    build:
      context: .
      dockerfile: qrng-gateway/Dockerfile
    image: ghcr.io/vbocan/qrng-gateway:latest
    container_name: qrng-gateway
    restart: unless-stopped

    # Environment variables
    environment:
      - QRNG_HMAC_SECRET_KEY=5f21dde6f44182da494e698ec24ea3c90df242cfb51a6acbebf28bb377d89a5e
      - QRNG_LISTEN_ADDRESS=0.0.0.0:8080
      - QRNG_BUFFER_SIZE=10485760
      - QRNG_API_KEYS=test-key-1234567890
      - QRNG_RATE_LIMIT_PER_SECOND=1000
      - LOG_LEVEL=info

    # Port mapping
    ports:
      - "8080:8080"

    # Network configuration
    networks:
      - qrng-network

    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  qrng-collector:
    build:
      context: .
      dockerfile: qrng-collector/Dockerfile
    image: ghcr.io/vbocan/qrng-collector:latest
    container_name: qrng-collector
    restart: unless-stopped

    # Environment variables
    environment:            
      - QRNG_APPLIANCE_URLS=https://random.cs.upt.ro/api/2.0/streambytes
      - QRNG_MIXING_STRATEGY=none
      - QRNG_PUSH_URL=http://qrng-gateway:8080/push
      - QRNG_HMAC_SECRET_KEY=5f21dde6f44182da494e698ec24ea3c90df242cfb51a6acbebf28bb377d89a5e
      - QRNG_FETCH_CHUNK_SIZE=8192
      - QRNG_FETCH_INTERVAL_MS=100
      - QRNG_BUFFER_SIZE=10485760
      - QRNG_PUSH_INTERVAL_MS=500
      - QRNG_MAX_RETRIES=5
      - QRNG_INITIAL_BACKOFF_MS=100
      - LOG_LEVEL=info

    # Network configuration
    networks:
      - qrng-network

    # Depends on gateway being available (commented out for debugging)
    # depends_on:
    #   qrng-gateway:
    #     condition: service_healthy

    # Health check (monitor logs since no HTTP endpoint)
    healthcheck:
      test: ["CMD-SHELL", "pgrep -f qrng-collector || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  qrng-network:
    driver: bridge
    name: qrng-network
